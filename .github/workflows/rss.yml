name: RSS Category Notifier

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils w3m jq

      - name: Process and Send Feeds to Slack Channels
        run: |
          FEEDS=(
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUUFNdGEU="
            "https://www.globenewswire.com/rssfeed/exchange/Nasdaq,NYSE"
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUVV5TE0U="
            "https://www.globenewswire.com/rssfeed/search/Positive%252520Topline/exchange/Nasdaq,NYSE"
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUVV5TE0E="
            "https://www.globenewswire.com/atomFeed/search/contract/exchange/Nasdaq,NYSE"
          )

          mkdir -p .cache

          declare -A BLOCKS
          declare -A WEBHOOKS

          WEBHOOKS[general]="${{ secrets.SLACK_WEBHOOK_GENERAL }}"
          WEBHOOKS[medical]="${{ secrets.SLACK_WEBHOOK_MEDICAL }}"
          WEBHOOKS[contracts]="${{ secrets.SLACK_WEBHOOK_CONTRACTS }}"

          BLOCKS[general]="[]"
          BLOCKS[medical]="[]"
          BLOCKS[contracts]="[]"

          for INDEX in "${!FEEDS[@]}"; do
            FEED_URL="${FEEDS[$INDEX]}"
            FEED_ID="feed_$INDEX"

            if [[ $INDEX -le 1 ]]; then
              CATEGORY="general"
            elif [[ $INDEX -le 3 ]]; then
              CATEGORY="medical"
            else
              CATEGORY="contracts"
            fi

            echo "ðŸ” Checking ($CATEGORY): $FEED_URL"
            XML=$(curl -s "$FEED_URL")

            for i in 1 2 3; do
              LINK=$(echo "$XML" | xmllint --xpath "string((//item|//entry)[$i]/link | (//item|//entry)[$i]/link/@href)" - 2>/dev/null)
              TITLE=$(echo "$XML" | xmllint --xpath "string((//item|//entry)[$i]/title)" - 2>/dev/null)
              DESCRIPTION=$(echo "$XML" | xmllint --xpath "string((//item|//entry)[$i]/description | //entry[$i]/summary)" - 2>/dev/null)
              PUBDATE=$(echo "$XML" | xmllint --xpath "string((//item|//entry)[$i]/pubDate | //entry[$i]/updated)" - 2>/dev/null)

              [ -z "$LINK" ] && continue
              [ -z "$TITLE" ] && TITLE="(No Title)"
              [ -z "$DESCRIPTION" ] && DESCRIPTION="(No summary available)"
              [ -z "$PUBDATE" ] && PUBDATE="(No date provided)"

              # Clean HTML
              DESCRIPTION=$(echo "$DESCRIPTION" | w3m -dump -T text/html | head -c 300)

              HASH=$(echo "$LINK" | md5sum | cut -d ' ' -f 1)
              HASH_FILE=".cache/${FEED_ID}_$HASH"
              if [ -f "$HASH_FILE" ]; then
                continue
              fi
              touch "$HASH_FILE"

              BLOCKS[$CATEGORY]=$(jq \
                --arg title "$TITLE" \
                --arg desc "$DESCRIPTION" \
                --arg link "$LINK" \
                --arg date "$PUBDATE" \
                '. + [
                  {
                    type: "section",
                    text: { type: "mrkdwn", text: "*ðŸ“° \($title)*\nðŸ“„ \($desc)\nðŸ”— <\($link)|Read more>\nðŸ•’ \($date)" }
                  },
                  {
                    type: "divider"
                  }
                ]' <<< "${BLOCKS[$CATEGORY]}")
            done
          done

          for CATEGORY in general medical contracts; do
            if [ "$(jq length <<< "${BLOCKS[$CATEGORY]}")" -gt 0 ]; then
              echo "ðŸ“¤ Sending $CATEGORY news to Slack..."
              curl -X POST "${WEBHOOKS[$CATEGORY]}" \
                -H 'Content-type: application/json' \
                --data "{\"blocks\": ${BLOCKS[$CATEGORY]}}"
            else
              echo "âœ… No new posts for $CATEGORY"
            fi
          done

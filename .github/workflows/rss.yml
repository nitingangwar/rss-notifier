name: RSS Slack Notifier

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Send RSS updates to Slack
        run: |
          FEEDS=(
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUUFNdGEU="
            "https://www.globenewswire.com/rssfeed/exchange/Nasdaq,NYSE"
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUVV5TE0U="
            "https://www.globenewswire.com/rssfeed/search/Positive%252520Topline/exchange/Nasdaq,NYSE"
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUVV5TE0E="
            "https://www.globenewswire.com/atomFeed/search/contract/exchange/Nasdaq,NYSE"
          )

          mkdir -p .cache

          for INDEX in "${!FEEDS[@]}"; do
            FEED_URL="${FEEDS[$INDEX]}"
            FEED_ID="feed_$INDEX"
            LAST_FILE=".cache/${FEED_ID}.last"

            echo "ðŸ” Checking: $FEED_URL"

            XML=$(curl -s "$FEED_URL")
            [ -z "$XML" ] && echo "âŒ Empty feed or failed to fetch $FEED_URL" && continue

            LINK=$(echo "$XML" | xmllint --xpath "string(//item[1]/link | //entry[1]/link/@href)" - 2>/dev/null)
            TITLE=$(echo "$XML" | xmllint --xpath "string(//item[1]/title | //entry[1]/title)" - 2>/dev/null)
            DESCRIPTION=$(echo "$XML" | xmllint --xpath "string(//item[1]/description | //entry[1]/summary)" - 2>/dev/null)
            PUBDATE=$(echo "$XML" | xmllint --xpath "string(//item[1]/pubDate | //entry[1]/updated)" - 2>/dev/null)

            [ -z "$TITLE" ] && TITLE="(No Title)"
            [ -z "$LINK" ] && echo "âŒ No link found, skipping..." && continue
            [ -z "$DESCRIPTION" ] && DESCRIPTION="(No summary available)"
            [ -z "$PUBDATE" ] && PUBDATE="(No date provided)"

            if [ -f "$LAST_FILE" ]; then
              LAST_LINK=$(cat "$LAST_FILE")
              if [ "$LAST_LINK" = "$LINK" ]; then
                echo "âœ… No new post for $FEED_URL"
                continue
              fi
            fi

            echo "$LINK" > "$LAST_FILE"

            echo "ðŸ“£ Sending to Slack: $TITLE"

            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              --data "{
                \"text\": \"ðŸ“° *${TITLE}*\n\nðŸ“„ ${DESCRIPTION}\n\nðŸ”— ${LINK}\nðŸ•’ ${PUBDATE}\"
              }"
          done

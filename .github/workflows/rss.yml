name: RSS Slack Notifier

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send RSS to Slack
        run: |
          FEEDS=(
            "https://feed.businesswire.com/rss/home/?rss=G1QFDERJXkJeEFpRXEMGSQ5SVFJUGExaFEhaUlJDFUkQUhFUUFNdGEU="
          )

          mkdir -p .cache

          for INDEX in "${!FEEDS[@]}"; do
            FEED_URL="${FEEDS[$INDEX]}"
            FEED_ID="feed_$INDEX"
            LAST_FILE=".cache/${FEED_ID}.last"

            echo "Checking $FEED_URL"

            XML=$(curl -s "$FEED_URL")
            [ -z "$XML" ] && echo "Empty feed: $FEED_URL" && continue

            XML=$(curl -s "$FEED_URL")
            [ -z "$XML" ] && echo "Empty feed: $FEED_URL" && continue
            
            LINK=$(echo "$XML" | xmllint --xpath "string(//item[1]/link)" - 2>/dev/null)
            TITLE=$(echo "$XML" | xmllint --xpath "string(//item[1]/title)" - 2>/dev/null)
            
            [ -z "$TITLE" ] && TITLE="(No Title)"
            [ -z "$LINK" ] && echo "No link found, skipping..." && continue


            [ -z "$LINK" ] && echo "No <link> found, skipping" && continue
            [ -z "$TITLE" ] && TITLE="(no title)"

            if [ -f "$LAST_FILE" ]; then
              LAST_LINK=$(cat "$LAST_FILE")
              if [ "$LAST_LINK" = "$LINK" ]; then
                echo "No new item for $FEED_URL"
                continue
              fi
            fi

            echo "$LINK" > "$LAST_FILE"

            echo "Sending to Slack: $TITLE"

            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸ“° *${TITLE}*\n${LINK}\"}"
          done

name: RSS Pushcut Notifier

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Pushcut for New RSS Items
        run: |
          FEEDS=(
            "https://www.globenewswire.com/rssfeed/search/Positive%252520Topline/exchange/Nasdaq,NYSE"
          )

          mkdir -p .cache

          for INDEX in "${!FEEDS[@]}"; do
            FEED_URL="${FEEDS[$INDEX]}"
            FEED_ID="feed_$INDEX"
            LAST_FILE=".cache/${FEED_ID}.last"

            echo "Checking $FEED_URL"

            XML=$(curl -s "$FEED_URL")
            [ -z "$XML" ] && echo "Empty feed: $FEED_URL" && continue

            LINK=$(echo "$XML" | grep -oPm1 "(?<=<link>)[^<]+")
            TITLE=$(echo "$XML" | grep -oPm1 "(?<=<title>)[^<]+" | sed -n 2p)

            [ -z "$LINK" ] && echo "No <link> found, skipping" && continue
            [ -z "$TITLE" ] && TITLE="(no title)"

            if [ -f "$LAST_FILE" ]; then
              LAST_LINK=$(cat "$LAST_FILE")
              if [ "$LAST_LINK" = "$LINK" ]; then
                echo "No new item for $FEED_URL"
                continue
              fi
            fi

            echo "$LINK" > "$LAST_FILE"

            echo "Sending notification for: $TITLE"

            curl -X POST https://api.pushcut.io/v1/notifications/RSS%20Update \
              -H "API-Key: ${{ secrets.PUSHCUT_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"$TITLE\",\"detail\":\"$LINK\"}"
          done
